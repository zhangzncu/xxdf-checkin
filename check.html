<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰“å¡ - å„¿ç«¥å­¦ä¹ æ‰“å¡</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <!-- æ¿€åŠ±è¯­ -->
    <div class="card welcome-card">
      <div class="welcome-text">å­¦ä¹ å¾ˆè‹¦</div>
      <div class="welcome-text cool-text">åšæŒå¾ˆé…·</div>
    </div>
    
    <!-- æ‰“å¡é¡¹ç›®åˆ—è¡¨ -->
    <div class="item-list" id="checkItems">
      <!-- é¡¹ç›®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <!-- åŠŸèƒ½æŒ‰é’®åŒºåŸŸ -->
    <div style="display: flex; gap: 15px; margin-bottom: 20px;">
      <div class="card add-item-card" onclick="showAddItemModal()" style="flex: 1;">
        <span class="add-icon">+</span>
        <span>æ·»åŠ é¡¹ç›®</span>
      </div>
      <div class="card add-item-card" onclick="toggleManageMode()" style="flex: 1; background-color: #f0f8ff; border-color: #ff6b6b;">
        <span class="add-icon">ğŸ—‘ï¸</span>
        <span>åˆ é™¤é¡¹ç›®</span>
      </div>
    </div>
    
    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="tab-bar">
      <a href="index.html" class="tab-item">
        <span class="tab-icon">ğŸ </span>
        <span class="tab-text">é¦–é¡µ</span>
      </a>
      <a href="check.html" class="tab-item active">
        <span class="tab-icon">âœ…</span>
        <span class="tab-text">æ‰“å¡</span>
      </a>
      <a href="record.html" class="tab-item">
        <span class="tab-icon">ğŸ“‹</span>
        <span class="tab-text">è®°å½•</span>
      </a>
      <a href="prize.html" class="tab-item">
        <span class="tab-icon">ğŸ</span>
        <span class="tab-text">å¥–å“</span>
      </a>
      <a href="setting.html" class="tab-item">
        <span class="tab-icon">âš™ï¸</span>
        <span class="tab-text">è®¾ç½®</span>
      </a>
    </div>
  </div>
  
  <!-- æ‰“å¡å¼¹çª— -->
  <div class="modal" id="checkModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-title" id="modalTitle">æ‰“å¡</div>
      <div class="stars-label">é€‰æ‹©å®Œæˆæƒ…å†µ</div>
      <div class="stars-selector" id="starsSelector"></div>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeCheckModal()">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="submitCheck()">ç¡®è®¤æ‰“å¡</button>
      </div>
    </div>
  </div>
  
  <!-- æ·»åŠ é¡¹ç›®å¼¹çª— -->
  <div class="modal" id="addItemModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">æ·»åŠ é¡¹ç›®</div>
      <div class="form-group">
        <label class="form-label">é¡¹ç›®åç§°</label>
        <input type="text" class="form-input" id="itemNameInput" placeholder="è¯·è¾“å…¥é¡¹ç›®åç§°">
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeAddItemModal()">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="submitAddItem()">æ·»åŠ </button>
      </div>
    </div>
  </div>
  
  <!-- ç®¡ç†æ¨¡å¼å¼¹çª— -->
  <div class="modal" id="deleteModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">åˆ é™¤ç¡®è®¤</div>
      <p style="text-align: center; margin-bottom: 15px; color: #666;">ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ <span id="deleteCount">0</span> ä¸ªé¡¹ç›®å—ï¼Ÿ</p>
      <p style="text-align: center; font-size: 12px; color: #999; margin-bottom: 20px;">å·²ç´¯ç§¯çš„æ˜Ÿæ˜Ÿä¸ä¼šè¢«åˆ é™¤</p>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeDeleteModal()">å–æ¶ˆ</button>
        <button class="btn-primary" style="background-color: #f44336;" onclick="confirmDelete()">ç¡®è®¤åˆ é™¤</button>
      </div>
    </div>
  </div>
  
  <style>
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 14px; color: #666; margin-bottom: 8px; }
    .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
    .add-item-card { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; cursor: pointer; border: 2px dashed #4CAF50; background-color: #f0f8ff; }
    .add-icon { font-size: 32px; color: #4CAF50; margin-bottom: 10px; }
  </style>
  
  <script src="wx-api.js"></script>
  <script>
    let checkItems = [];
    let isManageMode = false;
    let selectedItems = [];
    let currentItem = null;
    let selectedStars = 1;
    
    document.addEventListener('DOMContentLoaded', function() {
      loadCheckItems();
    });
    
    function loadCheckItems() {
      let items = wx.getStorageSync('checkItems');
      if (!items || !Array.isArray(items)) {
        items = [
          { id: 1, name: 'çº¢ç«ç®­', icon: 'book' },
          { id: 2, name: 'å¤è¯—è¯', icon: 'read' },
          { id: 3, name: 'ç»ƒå­—', icon: 'write' },
          { id: 4, name: 'è®¡ç®—', icon: 'calculate' },
          { id: 5, name: 'æ€ç»´', icon: 'thinking' }
        ];
        wx.setStorageSync('checkItems', items);
      }
      checkItems = items;
      renderItems();
    }
    
    function getIcon(iconType) {
      const icons = {
        'book': 'ğŸ“š',
        'read': 'ğŸ“–',
        'write': 'âœï¸',
        'calculate': 'ğŸ§®',
        'thinking': 'ğŸ’¡',
        'default': 'ğŸ“'
      };
      return icons[iconType] || icons['default'];
    }
    
    function renderItems() {
      const container = document.getElementById('checkItems');
      
      if (isManageMode) {
        // ç®¡ç†æ¨¡å¼
        container.innerHTML = checkItems.map(item => `
          <div class="card item-card ${selectedItems.includes(item.id) ? 'selected' : ''}" onclick="toggleSelect(${item.id})">
            <div class="item-checkbox ${selectedItems.includes(item.id) ? 'checked' : ''}">
              ${selectedItems.includes(item.id) ? 'âœ“' : ''}
            </div>
            <span class="item-icon">${getIcon(item.icon)}</span>
            <span class="item-name">${item.name}</span>
          </div>
        `).join('');
        
        if (checkItems.length === 0) {
          container.innerHTML = '<div class="empty-record">æš‚æ— æ‰“å¡é¡¹ç›®</div>';
        }
      } else {
        // æ­£å¸¸æ¨¡å¼
        container.innerHTML = checkItems.map(item => `
          <div class="card item-card" onclick="openCheckModal(${item.id}, '${item.name}')">
            <span class="item-icon">${getIcon(item.icon)}</span>
            <span class="item-name">${item.name}</span>
          </div>
        `).join('');
      }
      
      // ç®¡ç†æ¨¡å¼ä¸‹çš„æ“ä½œæ 
      // å…ˆæ¸…é™¤æ—§çš„æ“ä½œæ 
      const oldActionBar = document.querySelector('.action-bar');
      if (oldActionBar) {
        oldActionBar.remove();
      }
      
      if (isManageMode) {
        // åœ¨é¡µé¢é¡¶éƒ¨æ·»åŠ æ“ä½œæ 
        const actionBar = document.createElement('div');
        actionBar.className = 'card action-bar';
        actionBar.style.display = 'flex';
        actionBar.style.justifyContent = 'space-between';
        actionBar.style.alignItems = 'center';
        actionBar.style.marginBottom = '20px';
        actionBar.innerHTML = `
          <div style="font-weight: bold; color: #333;">åˆ é™¤é¡¹ç›®</div>
          <div style="display: flex; gap: 10px;">
            <button class="btn-manage" onclick="toggleManageMode()">å–æ¶ˆ</button>
            <button class="btn-manage delete-btn" onclick="batchDelete()" ${selectedItems.length === 0 ? 'disabled' : ''}>åˆ é™¤(${selectedItems.length})</button>
          </div>
        `;
        
        // æ’å…¥åˆ°æ¿€åŠ±è¯­å¡ç‰‡ä¸‹æ–¹
        const container = document.querySelector('.container');
        const welcomeCard = document.querySelector('.welcome-card');
        container.insertBefore(actionBar, welcomeCard.nextSibling);
      }
      
      // æ·»åŠ æ ·å¼
      if (!document.getElementById('item-styles')) {
        const style = document.createElement('style');
        style.id = 'item-styles';
        style.textContent = `
          .item-card { display: flex; align-items: center; padding: 20px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
          .item-card:active { transform: scale(0.98); }
          .item-icon { font-size: 28px; margin-right: 15px; }
          .item-name { font-size: 16px; font-weight: bold; color: #333; }
          .btn-manage { padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; }
          .item-checkbox { width: 24px; height: 24px; border: 2px solid #ddd; border-radius: 4px; margin-right: 15px; display: flex; align-items: center; justify-content: center; background: white; transition: all 0.2s; }
          .item-checkbox.checked { background: #f44336; border-color: #f44338; color: white; }
        .item-card.selected { background-color: #fff3f3; border: 2px solid #f44336; }
        .delete-btn { background-color: #f44336; margin-left: 10px; }
        .delete-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        `;
        document.head.appendChild(style);
      }
    }
    
    function toggleManageMode() {
      isManageMode = !isManageMode;
      selectedItems = [];
      renderItems();
    }
    
    function batchDelete() {
      if (selectedItems.length === 0) {
        wx.showToast({ title: 'è¯·é€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®' });
        return;
      }
      
      document.getElementById('deleteCount').textContent = selectedItems.length;
      document.getElementById('deleteModal').style.display = 'flex';
    }
    
    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
    }
    
    function confirmDelete() {
      const updatedItems = checkItems.filter(item => !selectedItems.includes(item.id));
      wx.setStorageSync('checkItems', updatedItems);
      
      wx.showToast({ title: 'åˆ é™¤æˆåŠŸ' });
      isManageMode = false;
      selectedItems = [];
      closeDeleteModal();
      loadCheckItems();
    }
    
    function toggleSelect(itemId) {
      if (selectedItems.includes(itemId)) {
        selectedItems = selectedItems.filter(id => id !== itemId);
      } else {
        selectedItems.push(itemId);
      }
      // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°åˆ é™¤æŒ‰é’®çŠ¶æ€
      renderItems();
    }
    
    function openCheckModal(itemId, itemName) {
      currentItem = { id: itemId, name: itemName };
      selectedStars = 1;
      
      document.getElementById('modalTitle').textContent = `æ‰“å¡ - ${itemName}`;
      
      const selector = document.getElementById('starsSelector');
      selector.innerHTML = [1, 2, 3].map(level => `
        <div class="star-item ${level === 1 ? 'active' : ''}" onclick="selectStars(${level})">
          ${Array(3).fill(0).map((_, i) => `
            <span class="star ${level >= i + 1 ? 'selected' : ''}">${level >= i + 1 ? 'â­' : 'â˜†'}</span>
          `).join('')}
          <span class="star-text">${level}æ˜Ÿ</span>
        </div>
      `).join('');
      
      document.getElementById('checkModal').style.display = 'flex';
    }
    
    function closeCheckModal() {
      document.getElementById('checkModal').style.display = 'none';
      currentItem = null;
    }
    
    function selectStars(level) {
      selectedStars = level;
      const selector = document.getElementById('starsSelector');
      selector.innerHTML = [1, 2, 3].map(l => `
        <div class="star-item ${l === level ? 'active' : ''}" onclick="selectStars(${l})">
          ${Array(3).fill(0).map((_, i) => `
            <span class="star ${l >= i + 1 ? 'selected' : ''}">${l >= i + 1 ? 'â­' : 'â˜†'}</span>
          `).join('')}
          <span class="star-text">${l}æ˜Ÿ</span>
        </div>
      `).join('');
    }
    
    function submitCheck() {
      if (!currentItem) return;
      
      // æ£€æŸ¥å½“å¤©æ˜¯å¦å·²ç»æ‰“å¡
      const now = new Date();
      const date = now.toLocaleDateString('zh-CN');
      const checkRecords = wx.getStorageSync('checkRecords') || [];
      
      // æ£€æŸ¥å½“å¤©è¯¥é¡¹ç›®æ˜¯å¦å·²ç»æ‰“å¡
      const todayRecord = checkRecords.find(record => 
        record.itemId === currentItem.id && record.date === date
      );
      
      if (todayRecord) {
        wx.showToast({ title: 'è¯¥é¡¹ç›®ä»Šå¤©å·²ç»æ‰“å¡è¿‡äº†' });
        return;
      }
      
      const time = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      
      const newRecord = {
        id: Date.now(),
        itemId: currentItem.id,
        itemName: currentItem.name,
        stars: selectedStars,
        date: date,
        time: time
      };
      checkRecords.push(newRecord);
      wx.setStorageSync('checkRecords', checkRecords);
      
      const totalStars = wx.getStorageSync('totalStars') || 0;
      wx.setStorageSync('totalStars', totalStars + selectedStars);
      
      wx.showToast({ title: 'æ‰“å¡æˆåŠŸ' });
      closeCheckModal();
    }
    
    function showAddItemModal() {
      document.getElementById('itemNameInput').value = '';
      document.getElementById('addItemModal').style.display = 'flex';
    }
    
    function closeAddItemModal() {
      document.getElementById('addItemModal').style.display = 'none';
    }
    
    function submitAddItem() {
      const name = document.getElementById('itemNameInput').value.trim();
      if (!name) {
        wx.showToast({ title: 'è¯·è¾“å…¥é¡¹ç›®åç§°' });
        return;
      }
      
      let maxId = 0;
      checkItems.forEach(item => {
        if (item.id > maxId) maxId = item.id;
      });
      
      const newItem = {
        id: maxId + 1,
        name: name,
        icon: 'default'
      };
      
      checkItems.push(newItem);
      wx.setStorageSync('checkItems', checkItems);
      
      wx.showToast({ title: 'æ·»åŠ æˆåŠŸ' });
      closeAddItemModal();
      loadCheckItems();
    }
    
    function batchDelete() {
      if (selectedItems.length === 0) {
        wx.showToast({ title: 'è¯·é€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®' });
        return;
      }
      
      document.getElementById('deleteCount').textContent = selectedItems.length;
      document.getElementById('deleteModal').style.display = 'flex';
    }
    
    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
    }
    
    function confirmDelete() {
      const updatedItems = checkItems.filter(item => !selectedItems.includes(item.id));
      wx.setStorageSync('checkItems', updatedItems);
      
      wx.showToast({ title: 'åˆ é™¤æˆåŠŸ' });
      isManageMode = false;
      selectedItems = [];
      closeDeleteModal();
      loadCheckItems();
    }
  </script>
</body>
</html>
