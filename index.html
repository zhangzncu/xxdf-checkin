<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å„¿ç«¥å­¦ä¹ æ‰“å¡</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    
    
    <!-- æ¿€åŠ±è¯­ -->
    <div class="card welcome-card">
      <div class="welcome-text">å­¦ä¹ å¾ˆè‹¦</div>
      <div class="welcome-text cool-text">åšæŒå¾ˆé…·</div>
    </div>
    
    <!-- æ˜Ÿæ˜Ÿæ€»æ•° -->
    <div class="card stars-card">
      <div class="stars-label">ç´¯è®¡æ˜Ÿæ˜Ÿ</div>
      <div class="stars-count" id="totalStars">0</div>
      <div class="stars">
        <span>â­</span><span>â­</span><span>â­</span>
      </div>
    </div>
    
    <!-- ä»Šæ—¥æ‰“å¡ -->
    <div class="card today-card">
      <div class="title">ä»Šæ—¥æ‰“å¡</div>
      <div class="today-status" id="todayStatus">0/0 é¡¹å·²å®Œæˆ</div>
      <div class="progress-bar">
        <div class="progress" id="progressBar"></div>
      </div>
      <button class="btn-primary" onclick="goToCheck()">å»æ‰“å¡</button>
    </div>
    
    <!-- æœ€è¿‘æ‰“å¡ -->
    <div class="card recent-card">
      <div class="title">æœ€è¿‘æ‰“å¡</div>
      <div class="record-list" id="recentRecords">
        <div class="empty-record">æš‚æ— æ‰“å¡è®°å½•</div>
      </div>
    </div>
    
    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="tab-bar">
      <a href="index.html" class="tab-item active">
        <span class="tab-icon">ğŸ </span>
        <span class="tab-text">é¦–é¡µ</span>
      </a>
      <a href="check.html" class="tab-item">
        <span class="tab-icon">âœ…</span>
        <span class="tab-text">æ‰“å¡</span>
      </a>
      <a href="record.html" class="tab-item">
        <span class="tab-icon">ğŸ“‹</span>
        <span class="tab-text">è®°å½•</span>
      </a>
      <a href="prize.html" class="tab-item">
        <span class="tab-icon">ğŸ</span>
        <span class="tab-text">å¥–å“</span>
      </a>
      <a href="setting.html" class="tab-item">
        <span class="tab-icon">âš™ï¸</span>
        <span class="tab-text">è®¾ç½®</span>
      </a>
    </div>
  </div>
  
  <!-- æ‰“å¡å¼¹çª— -->
  <div class="modal" id="checkModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-title" id="modalTitle">æ‰“å¡</div>
      <div class="stars-label">é€‰æ‹©å®Œæˆæƒ…å†µ</div>
      <div class="stars-selector" id="starsSelector"></div>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="submitCheck()">ç¡®è®¤æ‰“å¡</button>
      </div>
    </div>
  </div>
  
  <script src="wx-api.js"></script>
  <script src="app.js"></script>
  <script>
    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initData();
      loadData();
    });
    
    // åˆå§‹åŒ–æ•°æ®
    function initData() {
      // åˆå§‹åŒ–æ‰“å¡é¡¹ç›®
      let checkItems = wx.getStorageSync('checkItems');
      if (!checkItems || !Array.isArray(checkItems) || checkItems.length === 0) {
        const defaultItems = [
          { id: 1, name: 'çº¢ç«ç®­', icon: 'book' },
          { id: 2, name: 'å¤è¯—è¯', icon: 'read' },
          { id: 3, name: 'ç»ƒå­—', icon: 'write' },
          { id: 4, name: 'è®¡ç®—', icon: 'calculate' },
          { id: 5, name: 'æ€ç»´', icon: 'thinking' }
        ];
        wx.setStorageSync('checkItems', defaultItems);
      }
      
      // åˆå§‹åŒ–æ˜Ÿæ˜Ÿæ€»æ•°
      if (!wx.getStorageSync('totalStars')) {
        wx.setStorageSync('totalStars', 0);
      }
      
      // åˆå§‹åŒ–å…¶ä»–æ•°æ®
      if (!wx.getStorageSync('checkRecords')) {
        wx.setStorageSync('checkRecords', []);
      }
      if (!wx.getStorageSync('prizes')) {
        wx.setStorageSync('prizes', []);
      }
      if (!wx.getStorageSync('exchangeRecords')) {
        wx.setStorageSync('exchangeRecords', []);
      }
    }
    
    // åŠ è½½æ•°æ®
    function loadData() {
      // è·å–æ˜Ÿæ˜Ÿæ€»æ•°
      const totalStars = wx.getStorageSync('totalStars') || 0;
      document.getElementById('totalStars').textContent = totalStars;
      
      // è·å–æ‰“å¡é¡¹ç›®
      const checkItems = wx.getStorageSync('checkItems') || [];
      
      // è·å–ä»Šæ—¥æ‰“å¡è®°å½•
      const today = new Date().toLocaleDateString('zh-CN');
      const checkRecords = wx.getStorageSync('checkRecords') || [];
      const todayRecords = checkRecords.filter(r => r.date === today);
      const todayCheckCount = new Set(todayRecords.map(r => r.itemId)).size;
      
      // æ›´æ–°ä»Šæ—¥æ‰“å¡çŠ¶æ€
      document.getElementById('todayStatus').textContent = `${todayCheckCount}/${checkItems.length} é¡¹å·²å®Œæˆ`;
      const progress = checkItems.length > 0 ? (todayCheckCount / checkItems.length) * 100 : 0;
      document.getElementById('progressBar').style.width = progress + '%';
      
      // è·å–æœ€è¿‘æ‰“å¡è®°å½•
      const recentRecords = checkRecords
        .sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time))
        .slice(0, 5);
      
      const recordsContainer = document.getElementById('recentRecords');
      if (recentRecords.length > 0) {
        recordsContainer.innerHTML = recentRecords.map(record => `
          <div class="record-item">
            <span class="record-name">${record.itemName}</span>
            <span class="record-date">${record.date}</span>
            <div class="record-stars">
              ${Array(record.stars).fill('<span class="star">â­</span>').join('')}
            </div>
          </div>
        `).join('');
      } else {
        recordsContainer.innerHTML = '<div class="empty-record">æš‚æ— æ‰“å¡è®°å½•</div>';
      }
    }
    
    // è·³è½¬åˆ°æ‰“å¡é¡µé¢
    function goToCheck() {
      window.location.href = 'check.html';
    }
    
    // æ‰“å¡ç›¸å…³å˜é‡
    let selectedItem = null;
    let selectedStars = 1;
    
    // æ‰“å¡å¼¹çª—
    function openCheckModal(itemId, itemName) {
      selectedItem = { id: itemId, name: itemName };
      selectedStars = 1;
      
      document.getElementById('modalTitle').textContent = `æ‰“å¡ - ${itemName}`;
      
      // ç”Ÿæˆæ˜Ÿæ˜Ÿé€‰æ‹©å™¨
      const selector = document.getElementById('starsSelector');
      selector.innerHTML = [1, 2, 3].map(level => `
        <div class="star-item ${level === 1 ? 'active' : ''}" onclick="selectStars(${level})">
          ${Array(3).fill(0).map((_, i) => `
            <span class="star ${level >= i + 1 ? 'selected' : ''}">${level >= i + 1 ? 'â­' : 'â˜†'}</span>
          `).join('')}
          <span class="star-text">${level}æ˜Ÿ</span>
        </div>
      `).join('');
      
      document.getElementById('checkModal').style.display = 'flex';
    }
    
    function closeModal() {
      document.getElementById('checkModal').style.display = 'none';
    }
    
    function selectStars(level) {
      selectedStars = level;
      const selector = document.getElementById('starsSelector');
      selector.innerHTML = [1, 2, 3].map(l => `
        <div class="star-item ${l === level ? 'active' : ''}" onclick="selectStars(${l})">
          ${Array(3).fill(0).map((_, i) => `
            <span class="star ${l >= i + 1 ? 'selected' : ''}">${l >= i + 1 ? 'â­' : 'â˜†'}</span>
          `).join('')}
          <span class="star-text">${l}æ˜Ÿ</span>
        </div>
      `).join('');
    }
    
    function submitCheck() {
      if (!selectedItem) return;
      
      // è·å–å½“å‰æ—¥æœŸå’Œæ—¶é—´
      const now = new Date();
      const date = now.toLocaleDateString('zh-CN');
      const time = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      
      // è·å–å·²æœ‰è®°å½•
      const checkRecords = wx.getStorageSync('checkRecords') || [];
      
      // æ·»åŠ æ–°è®°å½•
      const newRecord = {
        id: Date.now(),
        itemId: selectedItem.id,
        itemName: selectedItem.name,
        stars: selectedStars,
        date: date,
        time: time
      };
      checkRecords.push(newRecord);
      wx.setStorageSync('checkRecords', checkRecords);
      
      // æ›´æ–°æ˜Ÿæ˜Ÿæ€»æ•°
      const totalStars = wx.getStorageSync('totalStars') || 0;
      wx.setStorageSync('totalStars', totalStars + selectedStars);
      
      wx.showToast({ title: 'æ‰“å¡æˆåŠŸ' });
      closeModal();
      loadData();
    }
  </script>
</body>
</html>
